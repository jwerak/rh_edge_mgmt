variant: r4e
version: 1.0.0
ignition:
  config:
    merge:
      - source: http://{{ image_builder_ip | default(ansible_host) }}/{{  gitea_user_name }}{{ user_number  }}/test/test-butane.ign
storage:
  files:
    - path: /var/tmp/aap-auto-registration.sh
      contents:
        inline: |
            #!/bin/bash
            sleep 5
            conn_name=$(nmcli con show | grep -v UUID | head -n 1 | awk '{print $1}')
            IP_ADDRESS=$(nmcli conn show $conn_name | grep ip_address | awk '{print $4}')
            MAC_ADDRESS=$(ip addr | grep $conn_name -A 1 | grep link | awk '{print $2}' | sed 's/://g')
            USER='{{  gitea_user_name }}{{ user_number }}'

            if rpm -q libreswan &> /dev/null; then
                IP_AAP_PRIVATE={{ aap_ip_private }}
                IP_AAP_PUBLIC={{ eda_ip | default(ansible_host) }}

                cat > /etc/ipsec.conf <<EOF
                config setup
                    protostack=netkey

                conn %default
                    ikelifetime=28800s
                    keylife=3600s
                    rekeymargin=3m
                    keyingtries=1
                    keyexchange=ike
                    ikev2=yes

                conn edgedevices
                    encapsulation=yes
                    left=${IP_AAP_PUBLIC}
                    leftid=${IP_AAP_PRIVATE}
                    right=${IP_ADDRESS}
                    authby=secret
                    auto=start
                    ike=3des-sha1,aes-sha1
                    esp=aes-sha2_512+sha2_256
                    leftsubnet=${IP_AAP_PRIVATE}/32
                    rightsubnets={192.168.0.0/16 172.16.0.0/12}
                EOF

                #cat > /etc/ipsec.secrets <<EOF
                ## GENERATED WHILE FDO ONBOARDING
                #EOF

                systemctl enable ipsec
                systemctl start ipsec 

                ipsec auto --up edgedevices

            fi

            if [ -z "$IP_ADDRESS" ] || [ -z "$MAC_ADDRESS" ] || [ -z "$USER" ]; then
                echo "One or more required variables are empty. Script failed."
                exit 1
            fi

            JSON="{\
            \"ip_address\": \"$IP_ADDRESS\", \
            \"user\": \"$USER\", \
            \"mac_address\": \"$MAC_ADDRESS\" \
            \"env\": \"\prod\" \
            }"

            /usr/bin/curl -H 'Content-Type: application/json' --data "$JSON" http://{{ eda_ip | default(ansible_host) }}:{{ eda_webhook_port | default('5000') }}
      mode: 0755
systemd:
  units:
    - name: aap-auto-registration.service
      contents: |
        [Unit]
        Description=Register to Ansible Automation Platform
        After=network.target
        After=connect-wifi.service
        ConditionPathExists=!/var/tmp/aap-registered
        [Service]
        Type=simple
        ExecStart=/bin/bash -c 'while true; do /var/tmp/aap-auto-registration.sh && /usr/bin/touch /var/tmp/aap-registered && break; done'
        [Install]
        WantedBy=default.target
      enabled: true
    - name: fdo-client-linuxapp.service
      dropins:
        - name: log_trace.conf
          contents: |
            [Service]
            Environment=LOG_LEVEL=trace

